<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Trade Canvas | STIR TRACKER</title>
    <link rel="stylesheet" href="style.css?v=3">
    <link rel="stylesheet" href="theme.css">
<style>
/* --- 既存スタイル --- */
.padded-section, .stats-container, .details-container, .global-footer { width: 100%; margin: 0 auto 20px; }
.stats-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
.grid { display: grid; grid-template-columns: repeat(7, 1fr); width: 100%; gap: 0 !important; border-top: 1px solid var(--border); border-left: 1px solid var(--border); border-right: 1px solid var(--border); box-sizing: border-box; }
.cell { aspect-ratio: 0.9; background: var(--card-bg); border-right: 1px solid var(--border); border-bottom: 1px solid var(--border); display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2px; overflow: hidden; position: relative; transition: background 0.2s; }
.cell:nth-child(7n) { border-right: none; }
.cell-date { font-size: 10px; color: var(--text-dim); align-self: flex-start; margin-left: 4px; margin-top: 4px; position:absolute; top:0; left:0; }
.cell-value { font-size: 10px; font-weight: bold; text-align: center; width: 100%; line-height: 1.1; word-break: break-all; white-space: normal; margin-top: 10px; }
.cell.editable { cursor: pointer; }
.cell.editable:hover { background: rgba(255, 255, 255, 0.05); }
.day-header-row { display: grid; grid-template-columns: repeat(7, 1fr); width: 100%; margin-bottom: 5px; text-align: center; }
.day-header { font-size: 9px; font-weight: bold; color: var(--text-dim); }
.bd-box { margin-bottom: 20px; background: var(--card-bg); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
.bd-header { background: var(--bg-color); padding: 8px 10px; font-size: 11px; font-weight: bold; color: var(--text-dim); border-bottom: 1px solid var(--border); }
.bd-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; border-bottom: 1px solid var(--border); font-size: 12px; }
.bd-row:last-child { border-bottom: none; }
.bd-name { color: var(--text-main); font-weight: bold; }
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 999; display: flex; justify-content: center; align-items: center; }
.modal-content { background: var(--card-bg); padding: 20px; border-radius: 8px; width: 90%; max-width: 400px; border: 1px solid var(--border); color: var(--text-main); }
.setting-row { display: flex; flex-direction: column; padding: 10px 0; border-bottom: 1px solid var(--border); }
.setting-controls { display: flex; align-items: center; gap: 8px; margin-top: 5px; }
.setting-input { flex: 1; padding: 8px; background: var(--bg-grid); border: 1px solid var(--border); color: var(--text-main); border-radius: 4px; font-size: 14px; }
.icon-btn { background: none; border: none; cursor: pointer; padding: 5px; display: flex; align-items: center; justify-content: center; color: var(--text-dim); transition: 0.2s; }
.icon-btn:hover { color: var(--text-main); }
.icon-btn.active { color: var(--accent-blue); }
.icon-btn.delete:hover { color: #ff6b6b; }
.svg-icon { width: 18px; height: 18px; fill: currentColor; }
.reset-btn { width: 30%; padding: 12px; background: transparent; border: 1px solid var(--text-dim); color: var(--text-dim); border-radius: 4px; font-weight: bold; cursor: pointer; }
.reset-btn:hover { border-color: #ff6b6b; color: #ff6b6b; }
.update-btn { width: 68%; padding: 12px; background: var(--accent-blue); color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; }
.detail-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border); }
.detail-info { flex: 1; }
.detail-name { font-weight: bold; font-size: 13px; color: var(--text-main); }
.detail-val { font-family: monospace; font-weight: bold; margin-top: 2px; }
.info-btn { margin-right: 8px; background: var(--bg-grid); border: 1px solid var(--border); color: var(--text-dim); border-radius: 4px; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
.info-btn:hover { border-color: var(--text-main); color: var(--text-main); }

/* アカウント情報テーブル */
.info-table { width: 100%; border-collapse: collapse; font-size: 13px; }
.info-table th { 
    text-align: left; 
    color: var(--text-dim); 
    padding: 12px 0;
    font-weight: normal; 
    width: 35%; 
    border-bottom: 1px solid var(--border); 
}
.info-table td { 
    text-align: right; 
    color: var(--text-main); 
    padding: 12px 0;
    font-weight: bold; 
    border-bottom: 1px solid var(--border); 
    font-family: monospace, sans-serif;
    font-size: 14px;
}
.info-table tr:last-child th, .info-table tr:last-child td { border-bottom: none; }

/* スイッチ */
.currency-control-row { display: flex; justify-content: flex-end; align-items: center; margin-bottom: 10px; }
.currency-switch { display: flex; background: var(--bg-grid); border: 1px solid var(--border); border-radius: 4px; overflow: hidden; }
.curr-btn { padding: 6px 16px; font-size: 12px; font-weight: bold; border: none; background: transparent; color: var(--text-dim); cursor: pointer; transition: 0.2s; min-width: 60px; }
.curr-btn.active { background: var(--accent-blue); color: white; }

/* 著作権表示 */
.copyright-text { text-align: center; font-size: 10px; color: var(--text-dim); margin-top: 20px; padding-bottom: 20px; opacity: 0.7; }
</style>
</head>
<body>

<div class="container">
    <header class="global-header">
        <div class="nav-container">
            <a href="#" class="logo"><span class="c-stir">STIR</span>&nbsp;<span class="c-tracker">TRACKER</span></a>
        </div>
    </header>

    <div class="padded-section" style="padding-top:20px;">
        
        <div class="currency-control-row">
            <div class="currency-switch">
                <button class="curr-btn active" id="currBtnJPY" onclick="setCurrency('JPY')">JPY</button>
                <button class="curr-btn" id="currBtnNative" onclick="setCurrency('Native')">USD</button>
            </div>
        </div>

        <div class="type-switch-container card-style">
            <button class="type-btn active" id="btnReal" onclick="switchType('Real')">REAL ACCOUNT</button>
            <button class="type-btn" id="btnDemo" onclick="switchType('Demo')">DEMO ACCOUNT</button>
        </div>

        <div class="top-bar">
            <select id="accountSelector" class="account-select" onchange="handleAccountChange()"></select>
            <button class="settings-btn" onclick="openSettings()">⚙ Setting</button>
        </div>
    </div>

    <div class="calendar-wrapper">
        <div class="calendar-header">
            <button onclick="changeMonth(-1)">＜</button>
            <div id="dateInfo">---- / --</div>
            <button onclick="changeMonth(1)">＞</button>
        </div>
        <div class="day-header-row">
            <span class="day-header" style="color:#ff6b6b">SUN</span>
            <span class="day-header">MON</span>
            <span class="day-header">TUE</span>
            <span class="day-header">WED</span>
            <span class="day-header">THU</span>
            <span class="day-header">FRI</span>
            <span class="day-header" style="color:#4dabf7">SAT</span>
        </div>
        <div class="grid" id="calendarGrid"></div>
    </div>

    <div class="padded-section">
        <div id="monthlyBreakdownContainer" class="bd-box" style="display:none;">
            <div class="bd-header">MONTHLY BREAKDOWN</div>
            <div id="monthlyBreakdownList"></div>
        </div>
        
        <div class="stats-container">
            <div class="stat-panel card-style">
                <span style="font-size:9px; color:var(--text-dim);">MONTHLY GAIN</span>
                <div><span class="main-val" id="monthlyGain">-- %</span></div>
            </div>
            <div class="stat-panel card-style">
                <span style="font-size:9px; color:var(--text-dim);">MONTHLY PROFIT</span>
                <div><span class="main-val" id="totalProfit">+0</span><span style="font-size:10px; color:var(--text-dim);" id="monthlyProfitUnit">JPY</span></div>
            </div>
        </div>

        <div class="details-container">
            <div class="section-header">TOTAL PORTFOLIO STATISTICS</div>
            <div class="total-stats-grid" style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <div class="ts-card card-style">
                    <div class="ts-label">TOTAL GAIN</div>
                    <div class="ts-value" id="totalGainPct">-- %</div>
                </div>
                <div class="ts-card card-style">
                    <div class="ts-label">TOTAL PROFIT</div>
                    <div class="ts-value" id="totalProfitAllTime">+0</div>
                </div>
            </div>
            <div class="ts-card full-width card-style" style="margin-top:10px; display:flex; justify-content:space-between; align-items:center;">
                <div class="ts-label">TOTAL BALANCE</div>
                <div class="ts-value" id="totalBalance" style="color:#ffd700;">0</div>
            </div>

            <div id="accountDetailsPanel" class="card-style" style="margin-top:10px; display:none; padding: 15px;">
                <div style="font-size:11px; font-weight:bold; letter-spacing: 1px; color:var(--text-dim); margin-bottom:5px; border-bottom:1px solid var(--border); padding-bottom:8px;">ACCOUNT INFORMATION</div>
                <div id="accountDetailsContent"></div>
            </div>
        </div>
        
        <footer class="global-footer">
            Last Update: <span id="lastTime">--:--:--</span>
            <span style="margin: 0 10px; color:var(--border);">|</span>
            USD/JPY: <span id="footerRate" style="color:var(--text-dim); font-weight:bold;">---.--</span>
        </footer>
        
        <div class="copyright-text">
            © 2026 STIR-CRAZY.COM. All rights reserved.
        </div>
    </div>
</div>

<div class="modal-overlay" id="settingsModal" style="display:none;">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center;">
            <span style="font-weight:bold;">Account Settings</span>
            <button onclick="closeSettings()" style="background:none; border:none; color:var(--text-dim); font-size:20px;">✕</button>
        </div>
        <div style="text-align:center; margin-bottom:15px;">
            <button onclick="changeTheme('cyber')" style="background:#0f1923; width:20px; height:20px; border:1px solid #555;"></button>
            <button onclick="changeTheme('light')" style="background:#fff; width:20px; height:20px; border:1px solid #ccc;"></button>
            <button onclick="changeTheme('midnight')" style="background:#191970; width:20px; height:20px; border:1px solid #555;"></button>
        </div>
        <div id="idListContainer" style="max-height:300px; overflow-y:auto; margin-bottom:15px;"></div>
        <button onclick="saveAndClose()" style="width:100%; padding:12px; background:var(--accent-blue); color:white; border:none; border-radius:4px; font-weight:bold;">Save Changes</button>
    </div>
</div>

<div class="modal-overlay" id="dailyDetailsModal" style="display:none;">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center;">
            <span style="font-weight:bold;" id="detailsDateLabel">Date Details</span>
            <button onclick="closeDailyDetails()" style="background:none; border:none; color:var(--text-dim); font-size:20px;">✕</button>
        </div>
        <div id="dailyDetailsList" style="max-height:300px; overflow-y:auto; margin-bottom:10px;"></div>
    </div>
</div>

<div class="modal-overlay" id="editProfitModal" style="display:none;">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center;">
            <span style="font-weight:bold;">Edit Daily Profit</span>
            <button onclick="closeEditProfit()" style="background:none; border:none; color:var(--text-dim); font-size:20px;">✕</button>
        </div>
        <div style="margin-bottom:15px;">
            <div id="editDateLabel" style="color:var(--text-dim); font-size:12px; margin-bottom:5px;">Date: ----.--.--</div>
            <input type="number" id="editProfitInput" class="setting-input" placeholder="Enter profit amount" style="width:100%;">
        </div>
        <div style="display:flex; justify-content:space-between; gap:10px;">
            <button onclick="revertInput()" class="reset-btn">Reset</button>
            <button onclick="saveProfitEdit()" class="update-btn">Update Profit</button>
        </div>
    </div>
</div>

<script>
    // ★★★ WorkersのURL ★★★
    const BASE_URL = "https://my-profit-app.stir-crazy-tracker.workers.dev";

    // アイコン定義
    const ICON_EYE_OPEN = `<svg class="svg-icon" viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>`;
    const ICON_EYE_SLASH = `<svg class="svg-icon" viewBox="0 0 24 24"><path d="M11.83 9L15 12.17V12a3 3 0 00-3-3h-.17zm-4.3.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm-2.53 6.35L2.1 19l1.41 1.41L20.59 3.41 19.17 2l-3.66 3.66C14.44 5.23 13.26 5 12 5 7 5 2.73 8.11 1 12.5c1.24 3.15 3.73 5.61 6.86 6.55.51.15 1.01.24 1.52.24.84 0 1.65-.24 2.37-.62l.1.1.26.26-.01-.03zM12 7c.27 0 .52.04.77.09L10.1 9.76c.04-.25.09-.5.09-.76 0-1.66 1.34-3 3-3z"/></svg>`;
    const ICON_TRASH = `<svg class="svg-icon" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>`;
    const ICON_EDIT = `<svg class="svg-icon" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>`;

    let currentYear = new Date().getFullYear();
    let currentMonth = new Date().getMonth();
    let accountsData = {};
    let allAccountIds = [];
    let accountSettings = {}; 
    let currentType = 'Real';
    let editingDate = null; 
    let editingAccountId = null;
    let initialModalValue = 0;

    let displayMode = 'JPY'; 
    let exchangeRates = { "JPY": 1, "USD": 150, "USC": 1.5, "EUR": 160 };

    window.onload = async () => {
        const savedTheme = localStorage.getItem('selected_theme');
        if (savedTheme) document.body.className = savedTheme;
        await fetchExchangeRates();
        await fetchAllData();
    };

    async function fetchExchangeRates() {
        try {
            const res = await fetch('https://api.frankfurter.app/latest?from=USD&to=JPY');
            const data = await res.json();
            if (data && data.rates && data.rates.JPY) {
                const usdJpy = data.rates.JPY;
                exchangeRates["USD"] = usdJpy;
                exchangeRates["USC"] = usdJpy / 100; 
                document.getElementById('footerRate').textContent = usdJpy.toFixed(2);
            } else {
                document.getElementById('footerRate').textContent = exchangeRates.USD.toFixed(2) + " (Def)";
            }
        } catch (e) {
            document.getElementById('footerRate').textContent = exchangeRates.USD.toFixed(2) + " (Off)";
        }
    }

    function setCurrency(mode) {
        displayMode = mode;
        document.getElementById('currBtnJPY').classList.toggle('active', mode === 'JPY');
        document.getElementById('currBtnNative').classList.toggle('active', mode === 'Native');
        updateUI(); 
    }

    function handleAccountChange() {
        const select = document.getElementById('accountSelector');
        const accountId = select.value;

        if (accountId === 'all') {
            setCurrency('JPY');
        } else {
            const s = accountSettings[accountId] || {};
            const curr = s.currency || 'JPY';
            if (curr === 'USD' || curr === 'USC') {
                setCurrency('Native');
            } else {
                setCurrency('JPY');
            }
        }
    }

    function getDisplayValue(amount, fromCurrency, isAllMode) {
        let amountInJPY = 0;
        if (fromCurrency === "USC") amountInJPY = amount * exchangeRates["USC"];
        else if (fromCurrency === "USD") amountInJPY = amount * exchangeRates["USD"];
        else amountInJPY = amount; 

        if (displayMode === 'JPY') {
            return { val: Math.floor(amountInJPY), unit: 'JPY', decimals: 0 };
        } else {
            if (isAllMode) {
                return { 
                    val: parseFloat((amountInJPY / exchangeRates["USD"]).toFixed(2)), 
                    unit: 'USD', 
                    decimals: 2 
                };
            } else {
                if (fromCurrency === 'JPY') {
                    return { 
                        val: parseFloat((amountInJPY / exchangeRates["USD"]).toFixed(2)), 
                        unit: 'USD', 
                        decimals: 2 
                    };
                } else {
                    let decimals = 0; 
                    if (fromCurrency === 'USD') decimals = 2;
                    else if (fromCurrency === 'USC') decimals = 2; 
                    return { val: amount, unit: fromCurrency, decimals: decimals };
                }
            }
        }
    }

    async function fetchAllData() {
        try {
            const res = await fetch(BASE_URL);
            const data = await res.json();
            accountsData = {};
            allAccountIds = [];
            accountSettings = {};

            if (data.settings) {
                data.settings.forEach(s => {
                    const id = String(s.account_id);
                    if (!allAccountIds.includes(id)) allAccountIds.push(id);
                    
                    let detectedCurrency = s.currency || "JPY";
                    const cSize = Number(s.contract_size) || 0;
                    if (detectedCurrency === "USD" && cSize === 1000) {
                        detectedCurrency = "USC";
                    }

                    accountSettings[id] = { 
                        name: s.name || "", 
                        isHidden: s.is_hidden === 1,
                        total_deposit: Number(s.total_deposit) || 0,
                        trade_mode: s.trade_mode || "Real",
                        equity: Number(s.equity) || 0,
                        broker: s.broker || "Unknown",
                        platform: s.platform || "MT4",
                        currency: detectedCurrency,
                        leverage: s.leverage || 0,
                        contract_size: cSize
                    };
                });
            }
            if (data.profits) {
                data.profits.forEach(item => {
                    const id = String(item.account_id);
                    if (!accountsData[id]) {
                        accountsData[id] = { balance: 0, history: [] };
                        if (!allAccountIds.includes(id)) allAccountIds.push(id);
                    }
                    if (item.timestamp.startsWith("9999")) {
                        accountsData[id].balance = Number(item.amount);
                    } else {
                        accountsData[id].history.push({
                            profit: Number(item.amount),
                            close_time: item.timestamp.replace(/-/g, '.')
                        });
                    }
                });
            }
            document.getElementById('lastTime').textContent = new Date().toLocaleTimeString();
            updateDropdown();
            updateUI();
        } catch (e) { console.error(e); }
    }

    function updateUI() {
        document.getElementById('dateInfo').textContent = `${currentYear} / ${currentMonth + 1}`;
        const grid = document.getElementById('calendarGrid');
        grid.innerHTML = '';
        const select = document.getElementById('accountSelector');
        const selectedId = (select && select.value) ? select.value : 'all';
        const isIndividual = selectedId !== 'all'; 

        const btnNative = document.getElementById('currBtnNative');
        if (isIndividual) {
            const s = accountSettings[selectedId] || {};
            const curr = s.currency || "JPY";
            if (curr === 'JPY') {
                btnNative.textContent = "USD";
            } else if (curr === 'USC') {
                btnNative.textContent = "USC";
            } else {
                btnNative.textContent = "USD";
            }
        } else {
            btnNative.textContent = "USD";
        }

        const firstDay = new Date(currentYear, currentMonth, 1).getDay();
        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
        for (let i = 0; i < firstDay; i++) grid.appendChild(createCell(i, 0, true));

        let monthlyTotalVal = 0;
        let finalUnit = 'JPY';
        let finalDecimals = 0;

        for (let d = 1; d <= daysInMonth; d++) {
            const dateStr = `${currentYear}.${String(currentMonth + 1).padStart(2, '0')}.${String(d).padStart(2, '0')}`;
            
            let cellDisplayVal = 0;
            let cellDecimals = 0;
            let rawVal = 0;
            let nativeCurr = 'JPY'; 

            if (isIndividual) {
                const s = accountSettings[selectedId] || {};
                nativeCurr = s.currency || "JPY";
                rawVal = getDailyProfit(selectedId, dateStr);
                const res = getDisplayValue(rawVal, nativeCurr, false);
                cellDisplayVal = res.val;
                
                if (res.unit === 'USD') cellDecimals = 2;
                else cellDecimals = 0; 

                finalUnit = res.unit;
                finalDecimals = res.decimals;
                
            } else {
                allAccountIds.forEach(id => {
                    const s = accountSettings[id] || {};
                    const isDemoAccount = (s.trade_mode === 'Demo');
                    const isTargetDemo = (currentType === 'Demo');
                    if (!s.isHidden && isDemoAccount === isTargetDemo) { 
                        const r = getDailyProfit(id, dateStr);
                        const res = getDisplayValue(r, s.currency || "JPY", true);
                        cellDisplayVal += res.val;
                        finalUnit = res.unit;
                        finalDecimals = res.decimals;
                    }
                });
                if(finalUnit === 'USD') cellDecimals = 2;
                else cellDecimals = 0;
            }

            monthlyTotalVal += cellDisplayVal;
            grid.appendChild(createCell(d, cellDisplayVal, cellDecimals, false, true, dateStr, rawVal, isIndividual ? selectedId : 'all', nativeCurr));
        }
        
        const sign = monthlyTotalVal > 0 ? "+" : "";
        const dispStr = monthlyTotalVal === 0 ? "0" : sign + monthlyTotalVal.toLocaleString(undefined, { minimumFractionDigits: finalDecimals, maximumFractionDigits: finalDecimals });
        
        document.getElementById('totalProfit').textContent = dispStr;
        document.getElementById('monthlyProfitUnit').textContent = finalUnit;
        
        updateAccountInfoPanel(isIndividual, selectedId);
        
        updateStats();
    }

    function createCell(day, amount, decimals, isEmpty=false, isEditable=false, dateStr='', rawVal=0, viewMode='all', currency='JPY') {
        const div = document.createElement('div');
        div.className = 'cell';
        if(isEmpty) { div.style.background='transparent'; return div; }
        
        div.innerHTML = `<div class="cell-date">${day}</div>`;
        if (amount !== 0) { 
            const absVal = Math.abs(amount);
            const valStr = absVal.toFixed(decimals);
            div.innerHTML += `<div class="cell-value" style="color:${amount >= 0 ? '#28a745' : '#dc3545'}">${valStr}</div>`; 
        }
        
        if (isEditable) {
            div.classList.add('editable');
            if (viewMode === 'all') {
                div.onclick = () => openDailyDetails(dateStr);
            } else {
                div.onclick = () => openEditProfit(dateStr, rawVal, viewMode, currency);
            }
        }
        return div;
    }

    function updateStats() {
        let totalBal = 0;
        let totalProfit = 0;
        let totalMonthly = 0;
        let totalDeposit = 0; 
        let statUnit = 'JPY';
        let statDecimals = 0;

        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
        const selectedId = document.getElementById('accountSelector').value || 'all';
        const isIndividual = selectedId !== 'all';
        const targetIds = (selectedId === 'all') ? allAccountIds : [selectedId];
        
        const breakdownList = document.getElementById('monthlyBreakdownList');
        if (breakdownList) breakdownList.innerHTML = '';
        let hasData = false;

        targetIds.forEach(id => {
            const s = accountSettings[id] || {};
            const isDemoAccount = (s.trade_mode === 'Demo');
            const isTargetDemo = (currentType === 'Demo');
            const currency = s.currency || "JPY";

            if ((!s.isHidden || selectedId !== 'all') && isDemoAccount === isTargetDemo) {
                const isAllForStats = !isIndividual; 
                
                if(accountsData[id]) {
                    const rawP = accountsData[id].history.reduce((sum, h) => sum + h.profit, 0);
                    const resP = getDisplayValue(rawP, currency, isAllForStats);
                    totalProfit += resP.val;
                    statUnit = resP.unit; 
                    statDecimals = resP.decimals;

                    const resB = getDisplayValue(accountsData[id].balance || 0, currency, isAllForStats);
                    totalBal += resB.val;
                }
                const resD = getDisplayValue(s.total_deposit || 0, currency, isAllForStats);
                totalDeposit += resD.val;

                let rawMonth = 0;
                for (let d = 1; d <= daysInMonth; d++) {
                    const dateStr = `${currentYear}.${String(currentMonth + 1).padStart(2, '0')}.${String(d).padStart(2, '0')}`;
                    rawMonth += getDailyProfit(id, dateStr);
                }
                
                if (breakdownList && selectedId === 'all') {
                    const row = document.createElement('div');
                    row.className = 'bd-row';
                    const resNative = getDisplayValue(rawMonth, currency, false); 
                    row.innerHTML = `
                        <span class="bd-name">${s.name || id}</span>
                        <span class="bd-val">${resNative.val.toLocaleString(undefined, {minimumFractionDigits:resNative.decimals})} ${resNative.unit}</span>
                    `;
                    breakdownList.appendChild(row);
                    hasData = true;
                }
                const resM = getDisplayValue(rawMonth, currency, isAllForStats);
                totalMonthly += resM.val;
            }
        });

        document.getElementById('monthlyBreakdownContainer').style.display = (hasData && selectedId === 'all') ? 'block' : 'none';
        
        const fmt = (num) => num.toLocaleString(undefined, { minimumFractionDigits: statDecimals, maximumFractionDigits: statDecimals });
        
        document.getElementById('totalBalance').innerHTML = `${fmt(totalBal)} <span style="font-size:12px; color:var(--text-dim);">${statUnit}</span>`;
        
        const allTimeSign = totalProfit > 0 ? "+" : "";
        const profitStr = (totalProfit===0 ? "0" : allTimeSign + fmt(totalProfit));
        document.getElementById('totalProfitAllTime').innerHTML = `${profitStr} <span style="font-size:12px; color:var(--text-dim);">${statUnit}</span>`;

        const gainEl = document.getElementById('totalGainPct');
        const monthlyGainEl = document.getElementById('monthlyGain');

        if (totalDeposit > 0) {
            const gain = (totalProfit / totalDeposit) * 100;
            const gainStr = gain.toFixed(2);
            if(gainStr === "0.00" || gainStr === "-0.00") gainEl.textContent = "0.00 %";
            else gainEl.textContent = (gain > 0 ? "+" : "") + gainStr + " %";

            const mStart = totalBal - totalMonthly;
            if (mStart > 0) {
                const mGain = (totalMonthly / mStart) * 100;
                const mGainStr = mGain.toFixed(2);
                if(mGainStr === "0.00" || mGainStr === "-0.00") monthlyGainEl.textContent = "0.00 %";
                else monthlyGainEl.textContent = (mGain > 0 ? "+" : "") + mGainStr + " %";
            } else { monthlyGainEl.textContent = "-- %"; }
        } else {
            gainEl.textContent = "-- %";
            monthlyGainEl.textContent = "-- %";
        }
    }

    // ★ パネル更新 (Last Update削除)
    function updateAccountInfoPanel(isIndividual, accountId) {
        const panel = document.getElementById('accountDetailsPanel');
        const content = document.getElementById('accountDetailsContent');
        if (!isIndividual || accountId === 'all') { panel.style.display = 'none'; return; }
        
        const s = accountSettings[accountId] || {};
        const cSizeRaw = Number(s.contract_size);
        const cSize = isNaN(cSizeRaw) || cSizeRaw === 0 ? '-' : cSizeRaw.toLocaleString();
        
        let idDisplay = `<span style="font-size:1.1em; color:var(--accent-blue);">${accountId}</span>`;
        if (s.name && s.name !== accountId) {
            idDisplay += ` <span style="font-size:0.9em; color:var(--text-dim); font-weight:normal;">(${s.name})</span>`;
        }

        content.innerHTML = `
            <table class="info-table">
                <tr><th>ID</th><td>${idDisplay}</td></tr>
                <tr><th>Broker</th><td>${s.broker}</td></tr>
                <tr><th>Type</th><td>${s.trade_mode}</td></tr>
                <tr><th>Platform</th><td>${s.platform}</td></tr>
                <tr><th>Currency</th><td>${s.currency}</td></tr>
                <tr><th>Leverage</th><td>1 : ${s.leverage}</td></tr>
                <tr><th>Contract Size</th><td>${cSize}</td></tr>
            </table>
        `;
        panel.style.display = 'block';
    }

    // ... 省略なし ...
    function openDailyDetails(dateStr) { document.getElementById('detailsDateLabel').textContent = `Details: ${dateStr}`; const list = document.getElementById('dailyDetailsList'); list.innerHTML = ''; allAccountIds.forEach(id => { const s = accountSettings[id] || {}; const isDemoAccount = (s.trade_mode === 'Demo'); const isTargetDemo = (currentType === 'Demo'); const currency = s.currency || "JPY"; if (!s.isHidden && isDemoAccount === isTargetDemo) { const rawProfit = getDailyProfit(id, dateStr); const color = rawProfit >= 0 ? '#28a745' : '#dc3545'; const res = getDisplayValue(rawProfit, currency, false); const valStr = res.val.toLocaleString(undefined, { minimumFractionDigits: res.decimals, maximumFractionDigits: res.decimals }); const div = document.createElement('div'); div.className = 'detail-row'; div.innerHTML = `<div class="detail-info"><div class="detail-name">${s.name || id}</div><div class="detail-val" style="color:${color}">${rawProfit > 0 ? '+' : ''}${valStr} <span style="font-size:10px;">${res.unit}</span></div></div><button class="icon-btn" onclick="openEditProfit('${dateStr}', ${rawProfit}, '${id}', '${currency}')" title="Edit">${ICON_EDIT}</button>`; list.appendChild(div); } }); document.getElementById('dailyDetailsModal').style.display = 'flex'; }
    function openEditProfit(dateStr, currentVal, accountId, currency='JPY') { editingDate = dateStr; editingAccountId = accountId; initialModalValue = currentVal; const accountName = accountSettings[accountId]?.name || accountId; const s = accountSettings[accountId] || {}; const nativeCurrency = s.currency || "JPY"; document.getElementById('editDateLabel').textContent = `Date: ${dateStr} (${accountName})`; const input = document.getElementById('editProfitInput'); input.value = currentVal; input.placeholder = `Amount in ${nativeCurrency}`; document.getElementById('editProfitModal').style.display = 'flex'; }
    function updateDropdown() { const select = document.getElementById('accountSelector'); if (!select) return; const currentVal = select.value; select.innerHTML = `<option value="all">ALL ${currentType.toUpperCase()} ACCOUNTS</option>`; allAccountIds.forEach(id => { const s = accountSettings[id] || { name: '', isHidden: false, trade_mode: 'Real' }; const isDemoAccount = (s.trade_mode === 'Demo'); const isTargetDemo = (currentType === 'Demo'); if (isDemoAccount === isTargetDemo && !s.isHidden) { const option = document.createElement('option'); option.value = id; option.textContent = s.name ? `${s.name} (${id})` : id; select.appendChild(option); } }); if (currentVal && Array.from(select.options).some(o => o.value === currentVal)) { select.value = currentVal; } else { select.value = "all"; } }
    function closeDailyDetails() { document.getElementById('dailyDetailsModal').style.display = 'none'; }
    function closeEditProfit() { document.getElementById('editProfitModal').style.display = 'none'; editingDate = null; editingAccountId = null; }
    function revertInput() { document.getElementById('editProfitInput').value = initialModalValue; }
    function closeAccountInfo() { document.getElementById('accountInfoModal').style.display = 'none'; }
    async function saveProfitEdit() { const newVal = document.getElementById('editProfitInput').value; if (!editingDate || !editingAccountId) return; try { await fetch(BASE_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ update_profit: { account_id: editingAccountId, date: editingDate, amount: newVal } }) }); await fetchAllData(); if (document.getElementById('dailyDetailsModal').style.display === 'flex') { openDailyDetails(editingDate); } closeEditProfit(); } catch(e) { alert("更新エラー"); } }
    function getDailyProfit(id, dateStr) { if (!accountsData[id]) return 0; return accountsData[id].history.filter(h => h.close_time.startsWith(dateStr)).reduce((sum, h) => sum + h.profit, 0); }
    function openSettings() { const modal = document.getElementById('settingsModal'); const container = document.getElementById('idListContainer'); container.innerHTML = ''; allAccountIds.forEach(id => { const s = accountSettings[id] || { name: '', isHidden: false, trade_mode: 'Real' }; const isDemoAccount = (s.trade_mode === 'Demo'); const isTargetDemo = (currentType === 'Demo'); if (isDemoAccount === isTargetDemo) { const div = document.createElement('div'); div.className = 'setting-row'; const eyeIcon = s.isHidden ? ICON_EYE_SLASH : ICON_EYE_OPEN; const eyeClass = s.isHidden ? '' : 'active'; const eyeOpacity = s.isHidden ? '0.5' : '1'; div.innerHTML = `<div style="font-size:10px; color:var(--text-dim); margin-bottom:2px;">${id}</div><div class="setting-controls"><input type="text" class="setting-input" id="name-${id}" value="${s.name}" placeholder="Account Name"><button type="button" class="icon-btn ${eyeClass}" style="opacity:${eyeOpacity}" onclick="toggleHide(this, '${id}')">${eyeIcon}</button><button type="button" class="icon-btn delete" onclick="deleteAccount('${id}')">${ICON_TRASH}</button></div><input type="hidden" id="hide-val-${id}" value="${s.isHidden ? '1' : '0'}">`; container.appendChild(div); } }); modal.style.display = 'flex'; }
    function toggleHide(btn, id) { const inputVal = document.getElementById(`hide-val-${id}`); const isHidden = inputVal.value === '1'; if (isHidden) { inputVal.value = '0'; btn.innerHTML = ICON_EYE_OPEN; btn.classList.add('active'); btn.style.opacity = '1'; } else { inputVal.value = '1'; btn.innerHTML = ICON_EYE_SLASH; btn.classList.remove('active'); btn.style.opacity = '0.5'; } }
    async function deleteAccount(id) { if (!confirm(`Delete ${id}?`)) return; try { await fetch(BASE_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ delete_account: id }) }); allAccountIds = allAccountIds.filter(aid => aid !== id); openSettings(); updateDropdown(); updateUI(); } catch(e) { alert("Error"); } }
    function closeSettings() { document.getElementById('settingsModal').style.display = 'none'; }
    function changeTheme(theme) { document.body.className = theme; localStorage.setItem('selected_theme', theme); }
    async function saveAndClose() { allAccountIds.forEach(id => { const nameInput = document.getElementById(`name-${id}`); const hideVal = document.getElementById(`hide-val-${id}`); if (nameInput && hideVal) { if (!accountSettings[id]) accountSettings[id] = {}; accountSettings[id].name = nameInput.value; accountSettings[id].isHidden = (hideVal.value === '1'); } }); try { await fetch(BASE_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ settings: accountSettings }) }); updateDropdown(); updateUI(); closeSettings(); } catch(e) { alert("Error"); } }
    function switchType(type) { currentType = type; document.getElementById('btnReal').classList.toggle('active', type === 'Real'); document.getElementById('btnDemo').classList.toggle('active', type === 'Demo'); updateDropdown(); updateUI(); }
    function changeMonth(step) { currentMonth += step; if (currentMonth > 11) { currentMonth = 0; currentYear++; } if (currentMonth < 0) { currentMonth = 11; currentYear--; } updateUI(); }
</script>
</body>
</html>

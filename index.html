<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Trade Canvas | STIR TRACKER</title>
    <link rel="stylesheet" href="style.css?v=3">
    <link rel="stylesheet" href="theme.css">
<style>
/* 基本スタイル */
.padded-section, .stats-container, .details-container, .global-footer { width: 100%; margin: 0 auto 20px; }
.stats-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
.grid { display: grid; grid-template-columns: repeat(7, 1fr); width: 100%; gap: 0 !important; border-top: 1px solid var(--border); border-left: 1px solid var(--border); border-right: 1px solid var(--border); box-sizing: border-box; }
.cell { aspect-ratio: 0.9; background: var(--card-bg); border-right: 1px solid var(--border); border-bottom: 1px solid var(--border); display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2px; overflow: hidden; position: relative; }
.cell:nth-child(7n) { border-right: none; }
.cell-date { font-size: 10px; color: var(--text-dim); align-self: flex-start; margin-left: 4px; margin-top: 4px; position:absolute; top:0; left:0; }
.cell-value { font-size: 10px; font-weight: bold; text-align: center; width: 100%; line-height: 1.1; word-break: break-all; white-space: normal; margin-top: 10px; }
.bd-box { margin-bottom: 20px; background: var(--card-bg); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
.bd-header { background: var(--bg-color); padding: 8px 10px; font-size: 11px; font-weight: bold; color: var(--text-dim); border-bottom: 1px solid var(--border); }
.bd-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; border-bottom: 1px solid var(--border); font-size: 12px; }
.bd-row:last-child { border-bottom: none; }
.bd-name { color: var(--text-main); font-weight: bold; }
/* 設定画面用 */
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 999; display: flex; justify-content: center; align-items: center; }
.modal-content { background: var(--card-bg); padding: 20px; border-radius: 8px; width: 90%; max-width: 400px; border: 1px solid var(--border); color: var(--text-main); }
.setting-row { display: flex; align-items: center; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid var(--border); }
</style>
</head>
<body>

<div class="container">
    <header class="global-header">
        <div class="nav-container">
            <a href="#" class="logo"><span class="c-stir">STIR</span>&nbsp;<span class="c-tracker">TRACKER</span></a>
        </div>
    </header>

    <div class="padded-section" style="padding-top:20px;">
        <div class="type-switch-container card-style">
            <button class="type-btn active" id="btnReal" onclick="switchType('Real')">REAL ACCOUNT</button>
            <button class="type-btn" id="btnDemo" onclick="switchType('Demo')">DEMO ACCOUNT</button>
        </div>

        <div class="top-bar">
            <select id="accountSelector" class="account-select" onchange="updateUI()"></select>
            <button class="settings-btn" onclick="openSettings()">⚙ Setting</button>
        </div>
    </div>

    <div class="calendar-wrapper">
        <div class="calendar-header">
            <button onclick="changeMonth(-1)">＜</button>
            <div id="dateInfo">---- / --</div>
            <button onclick="changeMonth(1)">＞</button>
        </div>
        <div class="grid" id="calendarGrid"></div>
    </div>

    <div class="padded-section">
        <div id="monthlyBreakdownContainer" class="bd-box" style="display:none;">
            <div class="bd-header">MONTHLY BREAKDOWN</div>
            <div id="monthlyBreakdownList"></div>
        </div>

        <div class="stats-container">
            <div class="stat-panel card-style">
                <span style="font-size:9px; color:var(--text-dim);">MONTHLY PROFIT</span>
                <div><span class="main-val" id="totalProfit">+0</span><span style="font-size:10px; color:var(--text-dim);"> JPY</span></div>
            </div>
            <div class="stat-panel card-style">
                <span style="font-size:9px; color:var(--text-dim);">MONTHLY GAIN</span>
                <div><span class="main-val" id="monthlyGain">-- %</span></div>
            </div>
        </div>

        <div class="details-container">
            <div class="section-header">TOTAL PORTFOLIO STATISTICS</div>
            <div class="total-stats-grid" style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                <div class="ts-card card-style">
                    <div class="ts-label">TOTAL GAIN</div>
                    <div class="ts-value" id="totalGainPct">-- %</div>
                </div>
                <div class="ts-card card-style">
                    <div class="ts-label">TOTAL PROFIT</div>
                    <div class="ts-value" id="totalProfitAllTime">+0</div>
                </div>
            </div>
            <div class="ts-card full-width card-style" style="margin-top:10px; display:flex; justify-content:space-between; align-items:center;">
                <div class="ts-label">TOTAL BALANCE</div>
                <div class="ts-value" id="totalBalance" style="color:#ffd700;">0</div>
            </div>
        </div>

        <footer class="global-footer">
            Last Update: <span id="lastTime">--:--:--</span>
        </footer>
    </div>
</div>

<div class="modal-overlay" id="settingsModal" style="display:none;">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
            <span style="font-weight:bold;">Account Settings</span>
            <button onclick="closeSettings()" style="background:none; border:none; color:var(--text-dim); font-size:18px;">✕</button>
        </div>
        
        <div style="text-align:center; margin-bottom:15px;">
            <div style="font-size:10px; color:var(--text-dim); margin-bottom:5px;">THEME</div>
            <button onclick="changeTheme('cyber')" style="background:#0f1923; width:20px; height:20px; border:1px solid #555;"></button>
            <button onclick="changeTheme('light')" style="background:#fff; width:20px; height:20px; border:1px solid #ccc;"></button>
            <button onclick="changeTheme('midnight')" style="background:#191970; width:20px; height:20px; border:1px solid #555;"></button>
        </div>

        <div id="idListContainer" style="max-height:300px; overflow-y:auto; margin-bottom:15px;"></div>
        
        <button onclick="saveAndClose()" style="width:100%; padding:10px; background:var(--accent-blue); color:white; border:none; border-radius:4px;">Save & Apply</button>
    </div>
</div>

<script>
    // ★★★ WorkersのURLをここに入れてください ★★★
    const BASE_URL = "https://my-profit-app.stir-crazy-tracker.workers.dev";

    let currentYear = new Date().getFullYear();
    let currentMonth = new Date().getMonth();
    let accountsData = {};
    let allAccountIds = [];
    let accountSettings = {}; 
    let currentType = 'Real';

    window.onload = () => {
        const savedTheme = localStorage.getItem('selected_theme');
        if (savedTheme) document.body.className = savedTheme;
        fetchAllData();
    };

    async function fetchAllData() {
        try {
            const res = await fetch(BASE_URL);
            const data = await res.json();
            
            accountsData = {};
            allAccountIds = [];
            accountSettings = {};

            // 設定データの読み込み（ID確保）
            if (data.settings) {
                data.settings.forEach(s => {
                    const id = String(s.account_id);
                    if (!allAccountIds.includes(id)) allAccountIds.push(id);
                    accountSettings[id] = { 
                        name: s.name || "", 
                        isHidden: s.is_hidden === 1,
                        total_deposit: Number(s.total_deposit) || 0,
                        // ★ NullならReal扱いにする重要ロジック
                        trade_mode: s.trade_mode || "Real",
                        equity: Number(s.equity) || 0
                    };
                });
            }

            // 取引データの読み込み
            if (data.profits) {
                data.profits.forEach(item => {
                    const id = String(item.account_id);
                    if (!accountsData[id]) {
                        accountsData[id] = { balance: 0, history: [] };
                        if (!allAccountIds.includes(id)) allAccountIds.push(id);
                    }
                    if (item.timestamp.startsWith("9999")) {
                        accountsData[id].balance = Number(item.amount);
                    } else {
                        accountsData[id].history.push({
                            profit: Number(item.amount),
                            close_time: item.timestamp.replace(/-/g, '.')
                        });
                    }
                });
            }

            document.getElementById('lastTime').textContent = new Date().toLocaleTimeString();
            updateDropdown();
            updateUI();
        } catch (e) {
            console.error(e);
        }
    }

    // ★ Real/Demoを正しく振り分けるロジック
    function updateDropdown() {
        const select = document.getElementById('accountSelector');
        if (!select) return;

        const currentVal = select.value;
        select.innerHTML = `<option value="all">ALL ${currentType.toUpperCase()} ACCOUNTS</option>`;

        allAccountIds.forEach(id => {
            const s = accountSettings[id] || { name: '', isHidden: false, trade_mode: 'Real' };
            
            // trade_modeが 'Demo' ならデモ、それ以外（null含む）はすべてReal
            const isDemoAccount = (s.trade_mode === 'Demo');
            const isTargetDemo = (currentType === 'Demo');

            if (isDemoAccount === isTargetDemo && !s.isHidden) {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = s.name ? `${s.name} (${id})` : id;
                select.appendChild(option);
            }
        });

        // 選択復元
        if (currentVal && Array.from(select.options).some(o => o.value === currentVal)) {
            select.value = currentVal;
        } else {
            select.value = "all";
        }
    }

    // ★ 設定画面を開くロジック
    function openSettings() {
        const modal = document.getElementById('settingsModal');
        const container = document.getElementById('idListContainer');
        container.innerHTML = '';

        allAccountIds.forEach(id => {
            const s = accountSettings[id] || { name: '', isHidden: false, trade_mode: 'Real' };
            // 現在のモードと一致するものだけ設定に表示
            const isDemoAccount = (s.trade_mode === 'Demo');
            const isTargetDemo = (currentType === 'Demo');

            if (isDemoAccount === isTargetDemo) {
                const div = document.createElement('div');
                div.className = 'setting-row';
                div.innerHTML = `
                    <div style="flex:1;">
                        <div style="font-size:10px; color:var(--text-dim);">${id}</div>
                        <input type="text" id="name-${id}" value="${s.name}" placeholder="Name" style="width:100%; padding:5px; margin-top:5px; background:var(--bg-grid); border:1px solid var(--border); color:var(--text-main);">
                    </div>
                    <div style="margin-left:10px;">
                        <label style="font-size:11px;"><input type="checkbox" id="hide-${id}" ${s.isHidden ? 'checked' : ''}> Hide</label>
                    </div>
                `;
                container.appendChild(div);
            }
        });
        modal.style.display = 'flex';
    }

    function closeSettings() { document.getElementById('settingsModal').style.display = 'none'; }
    
    function changeTheme(theme) {
        document.body.className = theme;
        localStorage.setItem('selected_theme', theme);
    }

    async function saveAndClose() {
        allAccountIds.forEach(id => {
            const nameInput = document.getElementById(`name-${id}`);
            const hideInput = document.getElementById(`hide-${id}`);
            // 設定画面にあるものだけ更新
            if (nameInput) {
                if (!accountSettings[id]) accountSettings[id] = {};
                accountSettings[id].name = nameInput.value;
                accountSettings[id].isHidden = hideInput.checked;
            }
        });

        // 設定保存（名前と非表示フラグのみ送信）
        try {
            await fetch(BASE_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ settings: accountSettings })
            });
            updateDropdown();
            updateUI();
            closeSettings();
        } catch(e) { alert("保存エラー"); }
    }

    function switchType(type) {
        currentType = type;
        document.getElementById('btnReal').classList.toggle('active', type === 'Real');
        document.getElementById('btnDemo').classList.toggle('active', type === 'Demo');
        updateDropdown();
        updateUI();
    }

    // UI更新（カレンダー・統計）
    function updateUI() {
        document.getElementById('dateInfo').textContent = `${currentYear} / ${currentMonth + 1}`;
        const grid = document.getElementById('calendarGrid');
        grid.innerHTML = '';
        const select = document.getElementById('accountSelector');
        const selectedId = (select && select.value) ? select.value : 'all';

        const firstDay = new Date(currentYear, currentMonth, 1).getDay();
        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

        for (let i = 0; i < firstDay; i++) grid.appendChild(createCell(i, 0, true));

        let monthlyTotal = 0;
        for (let d = 1; d <= daysInMonth; d++) {
            const dateStr = `${currentYear}.${String(currentMonth + 1).padStart(2, '0')}.${String(d).padStart(2, '0')}`;
            let dailyTotal = 0;
            if (selectedId === 'all') {
                allAccountIds.forEach(id => {
                    const s = accountSettings[id] || {};
                    const isDemoAccount = (s.trade_mode === 'Demo');
                    const isTargetDemo = (currentType === 'Demo');
                    if (!s.isHidden && isDemoAccount === isTargetDemo) {
                        dailyTotal += getDailyProfit(id, dateStr);
                    }
                });
            } else {
                dailyTotal = getDailyProfit(selectedId, dateStr);
            }
            monthlyTotal += dailyTotal;
            grid.appendChild(createCell(d, dailyTotal));
        }

        document.getElementById('totalProfit').textContent = (monthlyTotal >= 0 ? "+" : "") + monthlyTotal.toLocaleString();
        updateStats();
    }

    function createCell(day, amount, isEmpty=false) {
        const div = document.createElement('div');
        div.className = 'cell';
        if(isEmpty) { div.style.background='transparent'; return div; }
        
        div.innerHTML = `<div class="cell-date">${day}</div>`;
        if (amount !== 0) {
            div.innerHTML += `<div class="cell-value" style="color:${amount >= 0 ? '#28a745' : '#dc3545'}">${amount.toLocaleString()}</div>`;
        }
        return div;
    }

    function getDailyProfit(id, dateStr) {
        if (!accountsData[id]) return 0;
        return accountsData[id].history.filter(h => h.close_time.startsWith(dateStr)).reduce((sum, h) => sum + h.profit, 0);
    }

    function updateStats() {
        // 統計計算ロジック（省略せず実装）
        let totalBal = 0, totalProfitAll = 0, totalMonthlyProfit = 0, totalDepositAll = 0;
        const breakdownList = document.getElementById('monthlyBreakdownList');
        if (breakdownList) breakdownList.innerHTML = '';
        
        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
        const selectedId = document.getElementById('accountSelector').value || 'all';
        const targetIds = (selectedId === 'all') ? allAccountIds : [selectedId];
        let hasData = false;

        targetIds.forEach(id => {
            const s = accountSettings[id] || {};
            const isDemoAccount = (s.trade_mode === 'Demo');
            const isTargetDemo = (currentType === 'Demo');

            if ((!s.isHidden || selectedId !== 'all') && isDemoAccount === isTargetDemo) {
                if(accountsData[id]) {
                    const p = accountsData[id].history.reduce((sum, h) => sum + h.profit, 0);
                    totalProfitAll += p;
                    totalBal += (accountsData[id].balance || 0);
                }
                totalDepositAll += (s.total_deposit || 0);

                let monthProfit = 0;
                for (let d = 1; d <= daysInMonth; d++) {
                    const dateStr = `${currentYear}.${String(currentMonth + 1).padStart(2, '0')}.${String(d).padStart(2, '0')}`;
                    monthProfit += getDailyProfit(id, dateStr);
                }
                totalMonthlyProfit += monthProfit;

                if (breakdownList && selectedId === 'all') {
                    const row = document.createElement('div');
                    row.className = 'bd-row';
                    row.innerHTML = `<span class="bd-name">${s.name || id}</span><span class="bd-val">${monthProfit.toLocaleString()}</span>`;
                    breakdownList.appendChild(row);
                    hasData = true;
                }
            }
        });
        
        document.getElementById('monthlyBreakdownContainer').style.display = (hasData && selectedId === 'all') ? 'block' : 'none';
        document.getElementById('totalBalance').textContent = totalBal.toLocaleString();
        document.getElementById('totalProfitAllTime').textContent = (totalProfitAll >= 0 ? "+" : "") + totalProfitAll.toLocaleString();
        
        const gainEl = document.getElementById('totalGainPct');
        const monthlyGainEl = document.getElementById('monthlyGain');
        
        if (totalDepositAll > 0) {
            const gain = (totalProfitAll / totalDepositAll) * 100;
            gainEl.textContent = (gain >= 0 ? "+" : "") + gain.toFixed(2) + " %";
            const mStart = totalBal - totalMonthlyProfit;
            if (mStart > 0) {
                const mGain = (totalMonthlyProfit / mStart) * 100;
                monthlyGainEl.textContent = (mGain >= 0 ? "+" : "") + mGain.toFixed(2) + " %";
            } else { monthlyGainEl.textContent = "-- %"; }
        } else { gainEl.textContent = "-- %"; monthlyGainEl.textContent = "-- %"; }
    }
    
    function changeMonth(step) {
        currentMonth += step;
        if (currentMonth > 11) { currentMonth = 0; currentYear++; }
        if (currentMonth < 0) { currentMonth = 11; currentYear--; }
        updateUI();
    }
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Account FX Calendar</title>
    <style>
        /* シンプルで崩れにくいスタイル */
        body { font-family: sans-serif; margin: 20px; background: #f4f4f9; }
        h1 { text-align: center; color: #333; }
        .controls { text-align: center; margin-bottom: 20px; }
        select, button { padding: 10px; font-size: 16px; margin: 5px; }
        
        /* カレンダーのスタイル */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            max-width: 800px;
            margin: 0 auto;
        }
        .day-cell {
            background: white;
            padding: 10px;
            min-height: 80px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
        }
        .day-header { font-weight: bold; font-size: 0.9em; color: #666; margin-bottom: 5px; }
        .profit-positive { color: #28a745; font-weight: bold; }
        .profit-negative { color: #dc3545; font-weight: bold; }
        .daily-total { font-size: 1.1em; margin-top: 5px; display: block; }
        
        /* 設定モーダル */
        #settings-modal {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center; align-items: center;
        }
        .modal-content {
            background: white; padding: 20px; border-radius: 8px;
            width: 90%; max-width: 400px;
            max-height: 80vh; overflow-y: auto;
        }
        .setting-item { margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .setting-item input[type="text"] { width: 100%; box-sizing: border-box; padding: 5px; margin-top: 5px; }
    </style>
</head>
<body>

    <h1>FX Profit Calendar</h1>

    <div class="controls">
        <select id="account-select" onchange="updateUI()">
            <option value="all">全口座合計</option>
        </select>
        <button onclick="openSettings()">⚙ 設定</button>
    </div>

    <h2 style="text-align:center">
        <button onclick="changeMonth(-1)">◀</button>
        <span id="current-month-label"></span>
        <button onclick="changeMonth(1)">▶</button>
    </h2>

    <div id="calendar" class="calendar-grid"></div>

    <div id="settings-modal">
        <div class="modal-content">
            <h3>口座名の設定</h3>
            <div id="settings-container"></div>
            <div style="text-align: right; margin-top: 20px;">
                <button onclick="closeSettings()">キャンセル</button>
                <button onclick="saveAndClose()" style="background:#007bff; color:white;">保存 (Apply)</button>
            </div>
        </div>
    </div>

<script>
    // ★★★ ここをあなたのWorkersのURLに書き換えてください ★★★
    const BASE_URL = "https://my-profit-app.stir-crazy-tracker.workers.dev";

    let currentYear = new Date().getFullYear();
    let currentMonth = new Date().getMonth();
    let accountsData = {};
    let allAccountIds = [];
    let accountSettings = {}; 

    // 1. 起動時にデータを読み込む
    window.onload = function() {
        fetchAllData();
    };

    // 2. データ取得
    async function fetchAllData() {
        try {
            const res = await fetch(BASE_URL);
            const data = await res.json();
            
            const profits = data.profits || data || [];
            const settings = data.settings || [];

            accountsData = {};
            allAccountIds = [];
            
            // 設定を反映
            settings.forEach(s => {
                accountSettings[s.account_id] = {
                    name: s.name,
                    isHidden: s.is_hidden === 1
                };
            });

            // 利益データを整理
            profits.forEach(item => {
                const id = item.account_id;
                if (!accountsData[id]) {
                    accountsData[id] = { balance: 0, history: [] };
                    allAccountIds.push(id);
                }
                if (item.timestamp.startsWith("9999")) {
                    accountsData[id].balance = Number(item.amount);
                } else {
                    accountsData[id].history.push({
                        profit: Number(item.amount),
                        close_time: item.timestamp.replace(/-/g, '.')
                    });
                }
            });

            // もし古いHTMLにこの関数があれば実行、なければスキップ
            if (typeof updateDropdown === "function") updateDropdown();
            updateUI();
        } catch (e) {
            console.error("Load Error:", e);
        }
    }

    // 3. 設定保存機能（HTML側のIDに関わらず動作するように調整済み）
    async function saveAndClose() {
        // 画面上の入力欄を探してデータを吸い上げる
        allAccountIds.forEach(id => {
            const nameInput = document.getElementById(`name-${id}`);
            const hideInput = document.getElementById(`hide-${id}`);
            if (nameInput) {
                accountSettings[id] = {
                    name: nameInput.value || id,
                    isHidden: hideInput ? hideInput.checked : false
                };
            }
        });

        try {
            const response = await fetch(BASE_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ settings: accountSettings })
            });
            
            const txt = await response.text();
            if (response.ok) {
                if (!txt.includes("Skipped")) {
                    alert("✅ サーバーに保存しました！");
                }
                // 設定画面を閉じる関数があれば呼ぶ
                if (typeof closeSettings === "function") closeSettings();
                location.reload(); 
            } else {
                alert("保存エラー: " + txt);
            }
        } catch (e) {
            alert("通信エラー: " + e.message);
        }
    }

    // --- カレンダー表示ロジック（古いHTMLと互換性を持たせる） ---
    function updateUI() {
        const calendar = document.getElementById('calendar');
        if (!calendar) return; // カレンダー要素がなければ何もしない
        
        calendar.innerHTML = '';
        
        // プルダウンがあれば選択値を取得、なければ'all'
        const select = document.getElementById('account-select');
        const selectedId = select ? select.value : 'all';
        
        const year = currentYear;
        const month = currentMonth;

        const label = document.getElementById('current-month-label');
        if (label) label.textContent = `${year}年 ${month + 1}月`;

        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        // 空白セル
        for (let i = 0; i < firstDay; i++) {
            calendar.appendChild(createCell(''));
        }

        // 日付セル
        for (let d = 1; d <= daysInMonth; d++) {
            const dateStr = `${year}.${String(month + 1).padStart(2, '0')}.${String(d).padStart(2, '0')}`;
            let total = 0;

            if (selectedId === 'all') {
                allAccountIds.forEach(id => {
                    const s = accountSettings[id] || {};
                    if (!s.isHidden) {
                        total += getDailyProfit(id, dateStr);
                    }
                });
            } else {
                total = getDailyProfit(selectedId, dateStr);
            }

            calendar.appendChild(createCell(d, total));
        }
    }

    function getDailyProfit(id, dateStr) {
        if (!accountsData[id]) return 0;
        return accountsData[id].history
            .filter(h => h.close_time.startsWith(dateStr))
            .reduce((sum, h) => sum + h.profit, 0);
    }

    function createCell(day, amount) {
        const div = document.createElement('div');
        div.className = 'day-cell';
        if (!day) return div;

        div.innerHTML = `<div class="day-header">${day}</div>`;
        
        // スタイルクラス名は古いHTMLに合わせる必要があるかもですが、一旦標準的なもので
        if (amount !== undefined && amount !== 0) {
            const colorClass = amount >= 0 ? 'profit-positive' : 'profit-negative';
            // 色がつかない場合は、古いCSSに 'profit-positive' がない可能性があります
            // その場合は style タグを直接埋め込む
            const colorStyle = amount >= 0 ? 'color:#28a745;' : 'color:#dc3545;';
            div.innerHTML += `<span class="daily-total ${colorClass}" style="${colorStyle} font-weight:bold;">${amount.toLocaleString()}</span>`;
        }
        return div;
    }

    function changeMonth(step) {
        currentMonth += step;
        if (currentMonth > 11) { currentMonth = 0; currentYear++; }
        if (currentMonth < 0) { currentMonth = 11; currentYear--; }
        updateUI();
    }
</script>
</body>
</html>


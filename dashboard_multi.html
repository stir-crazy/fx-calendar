<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Trade Canvas | STIR TRACKER</title>
    <link rel="stylesheet" href="style.css?v=3">
    <link rel="stylesheet" href="theme.css">
<style>
/* é ‚ã„ãŸCSSã‚’ãã®ã¾ã¾ç¶­æŒ */
.padded-section, 
.stats-container, 
.details-container, 
.global-footer { width: 100%; margin: 0 auto 20px; }
.stats-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
.grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    width: 100%;
    gap: 0 !important;
    border-top: 1px solid var(--border);
    border-left: 1px solid var(--border);
    border-right: 1px solid var(--border);
    box-sizing: border-box;
}
.cell {
    aspect-ratio: 0.9;
    background: var(--card-bg);
    border-right: 1px solid var(--border);
    border-bottom: 1px solid var(--border);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start; 
    padding: 5px;
    overflow: hidden;
    position: relative;
}
.cell:nth-child(7n) { border-right: none; }
.cell-date { font-size: 10px; color: var(--text-dim); align-self: flex-start; margin-bottom: 2px; }
.cell-value {
    font-size: 10px;
    font-weight: bold;
    text-align: center;
    width: 100%;
    line-height: 1.2;
    word-break: break-all;
    white-space: normal;
    margin-top: auto; margin-bottom: auto;
}
#settingsModal .modal-content { width: 90%; max-width: 400px; }
.bd-box { margin-bottom: 20px; background: var(--card-bg); border: 1px solid var(--border); border-radius: 8px; overflow: hidden; }
.bd-header { background: var(--bg-color); padding: 8px 10px; font-size: 11px; font-weight: bold; color: var(--text-dim); border-bottom: 1px solid var(--border); }
.bd-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; border-bottom: 1px solid var(--border); font-size: 12px; }
.bd-row:last-child { border-bottom: none; }
.bd-name { color: var(--text-main); font-weight: bold; }
.bd-val { font-family: monospace; font-weight: bold; }

/* è¨­å®šç”»é¢å†…ã®ã‚¹ã‚¿ã‚¤ãƒ«èª¿æ•´ */
.setting-row { display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid var(--border); }
.setting-row input[type="text"] { flex: 1; background: var(--bg-grid); border: 1px solid var(--border); color: var(--text-main); padding: 5px; border-radius: 4px; }
</style>
</head>
<body>

<div id="update-flash"></div>

    <header class="global-header">
        <div class="nav-container">
            <a href="index.html" class="logo">
                <span class="c-stir"><span class="c1">S</span><span class="c2">T</span><span class="c3">I</span><span class="c4">R</span></span>
                &nbsp;
                <span class="c-tracker"><span class="c5">T</span><span class="c6">R</span><span class="c7">A</span><span class="c8">C</span><span class="c9">K</span><span class="c10">E</span><span class="c11">R</span></span>
            </a>
            <ul class="nav-menu">
                <li class="nav-item"><a href="#" class="nav-icon active">ğŸ“Š</a></li>
            </ul>
        </div>
    </header>

<div class="container">
    
    <div class="padded-section" style="padding-bottom:0;">
        <div class="type-switch-container card-style">
            <button class="type-btn active" id="btnReal" onclick="switchType('Real')">REAL ACCOUNT</button>
            <button class="type-btn" id="btnDemo" onclick="switchType('Demo')">DEMO ACCOUNT</button>
        </div>

        <div class="top-bar">
            <select id="accountSelector" class="account-select" onchange="updateUI()"></select>
            <button class="settings-btn" onclick="openSettings()">âš™ Setting</button>
        </div>
    </div>

    <div class="calendar-wrapper">
        <div class="calendar-header">
            <button onclick="changeMonth(-1)" style="background:var(--btn-bg); border:1px solid var(--btn-border); color:var(--text-main); width:28px; height:28px; border-radius:50%; cursor:pointer;">ï¼œ</button>
            <div id="dateInfo" style="font-weight:bold; font-size:15px; color:var(--text-main);">---- / --</div>
            <button onclick="changeMonth(1)" style="background:var(--btn-bg); border:1px solid var(--btn-border); color:var(--text-main); width:28px; height:28px; border-radius:50%; cursor:pointer;">ï¼</button>
        </div>
        <div class="grid" id="calendarGrid"></div>
    </div>

    <div class="padded-section">
        
        <div class="stats-container">
            <div class="stat-panel card-style">
                <span style="font-size:9px; color:var(--text-dim); margin-bottom:5px;">MONTHLY PROFIT</span>
                <div><span class="main-val" id="totalProfit">+0</span><span style="font-size:10px; color:var(--text-dim);"> JPY</span></div>
            </div>
            <div class="stat-panel card-style">
                <span style="font-size:9px; color:var(--text-dim); margin-bottom:5px;">TOTAL BALANCE</span>
                <div><span class="main-val" id="totalBalance" style="color:#ffd700;">0</span></div>
            </div>
        </div>

        <footer class="global-footer">
            Last Update: <span id="lastTime">--:--:--</span><br>
            &copy; 2026 STIR CRAZY.
        </footer>
    </div>
</div>

<div class="modal-overlay" id="settingsModal" style="display:none;">
    <div class="modal-content card-style" style="max-height:85vh; overflow-y:auto;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <span class="modal-title">Account Settings</span>
            <button onclick="closeSettings()" style="background:none; border:none; color:var(--text-dim); font-size:18px; cursor:pointer;">âœ•</button>
        </div>
        
        <div style="font-size:11px; color:var(--text-dim); font-weight:bold; margin-bottom:10px;">NAME SETTINGS</div>
        <div id="idListContainer" style="max-height:300px; overflow-y:auto; padding-right:5px; margin-bottom:20px;">
            </div>
        
        <button style="width:100%; padding:14px; background:var(--accent-blue); color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer; box-shadow:0 2px 5px rgba(0,0,0,0.2);" onclick="saveAndClose()">Apply Settings</button>
    </div>
</div>

<script>
    // â˜…â˜…â˜… â†“â†“ Workersã®URLã«æ›¸ãæ›ãˆã¦ãã ã•ã„ â†“â†“ â˜…â˜…â˜…
    const BASE_URL = "https://my-profit-app.stir-crazy-tracker.workers.dev";
    // â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…

    let currentYear = new Date().getFullYear();
    let currentMonth = new Date().getMonth();
    let accountsData = {};
    let allAccountIds = [];
    let accountSettings = {}; 
    let currentType = 'Real'; // Real or Demo

    // 1. èµ·å‹•æ™‚ã«å®Ÿè¡Œ
    window.onload = function() {
        // ãƒ†ãƒ¼ãƒã®å¾©å…ƒï¼ˆä¿å­˜ã•ã‚Œã¦ã„ã‚Œã°ï¼‰
        const savedTheme = localStorage.getItem('selected_theme');
        if (savedTheme) changeTheme(savedTheme);
        fetchAllData();
    };

    // 2. ãƒ‡ãƒ¼ã‚¿å–å¾—
    async function fetchAllData() {
        try {
            const res = await fetch(BASE_URL);
            const data = await res.json();
            
            const profits = data.profits || [];
            const settings = data.settings || [];

            accountsData = {};
            allAccountIds = [];
            
            // è¨­å®šåæ˜ 
            settings.forEach(s => {
                accountSettings[s.account_id] = {
                    name: s.name,
                    isHidden: s.is_hidden === 1
                };
            });

            // åˆ©ç›Šãƒ‡ãƒ¼ã‚¿æ•´ç†
            profits.forEach(item => {
                const id = item.account_id;
                if (!accountsData[id]) {
                    accountsData[id] = { balance: 0, history: [] };
                    allAccountIds.push(id);
                }
                if (item.timestamp.startsWith("9999")) {
                    accountsData[id].balance = Number(item.amount);
                } else {
                    accountsData[id].history.push({
                        profit: Number(item.amount),
                        close_time: item.timestamp.replace(/-/g, '.')
                    });
                }
            });

            document.getElementById('lastTime').textContent = new Date().toLocaleTimeString();
            updateDropdown();
            updateUI(); // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ›´æ–°
            updateStats(); // â˜…è¿½åŠ ï¼šçµ±è¨ˆã¨Breakdownæ›´æ–°

        } catch (e) {
            console.error(e);
            alert("ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼");
        }
    }

    // 3. ç”»é¢å…¨ä½“ï¼ˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ»åˆè¨ˆï¼‰ã®æ›´æ–°
    function updateUI() {
        // æ—¥ä»˜è¡¨ç¤º
        document.getElementById('dateInfo').textContent = `${currentYear} / ${currentMonth + 1}`;

        const grid = document.getElementById('calendarGrid');
        grid.innerHTML = '';

        const select = document.getElementById('accountSelector');
        const selectedId = select ? select.value : 'all';

        const firstDay = new Date(currentYear, currentMonth, 1).getDay();
        const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

        // ç©ºç™½ã‚»ãƒ«
        for (let i = 0; i < firstDay; i++) {
            const cell = document.createElement('div');
            cell.className = 'cell';
            cell.style.background = 'transparent';
            grid.appendChild(cell);
        }

        let monthlyTotal = 0;

        // æ—¥ä»˜ã‚»ãƒ«
        for (let d = 1; d <= daysInMonth; d++) {
            const dateStr = `${currentYear}.${String(currentMonth + 1).padStart(2, '0')}.${String(d).padStart(2, '0')}`;
            let dailyTotal = 0;

            if (selectedId === 'all') {
                allAccountIds.forEach(id => {
                    const s = accountSettings[id] || {};
                    if (!s.isHidden) dailyTotal += getDailyProfit(id, dateStr);
                });
            } else {
                dailyTotal = getDailyProfit(selectedId, dateStr);
            }

            monthlyTotal += dailyTotal;
            grid.appendChild(createCell(d, dailyTotal));
        }

        // æœˆæ¬¡åˆè¨ˆè¡¨ç¤º
        const profitEl = document.getElementById('totalProfit');
        profitEl.textContent = (monthlyTotal > 0 ? "+" : "") + monthlyTotal.toLocaleString();
        profitEl.style.color = monthlyTotal >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
        
        // Breakdownãªã©ã‚‚æ›´æ–°
        updateStats();
    }

    // â˜…è¿½åŠ æ©Ÿèƒ½ï¼šçµ±è¨ˆã¨è©³ç´°ãƒªã‚¹ãƒˆï¼ˆBreakdownï¼‰ã®è¡¨ç¤º
    function updateStats() {
        // 1. å…¨æ®‹é«˜ã®è¨ˆç®—
        let totalBal = 0;
        let totalProfitAll = 0; // å…¨æœŸé–“åˆ©ç›Šï¼ˆç°¡æ˜“ï¼‰

        // 2. Breakdownãƒªã‚¹ãƒˆã®ä½œæˆ
        const breakdownList = document.getElementById('monthlyBreakdownList');
        const breakdownContainer = document.getElementById('monthlyBreakdownContainer');
        
        if (breakdownList) {
            breakdownList.innerHTML = '';
            let hasData = false;
            
            // ç¾åœ¨ã®æœˆã®ãƒ‡ãƒ¼ã‚¿ã‚’å£åº§ã”ã¨ã«é›†è¨ˆ
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();

            allAccountIds.forEach(id => {
                const s = accountSettings[id] || {};
                if (s.isHidden) return; // éš ã—ã¦ã„ã‚‹å£åº§ã¯ã‚¹ã‚­ãƒƒãƒ—

                // æ®‹é«˜åŠ ç®—
                totalBal += (accountsData[id].balance || 0);

                // ã“ã®æœˆã®åˆ©ç›Šã‚’è¨ˆç®—
                let monthProfit = 0;
                for (let d = 1; d <= daysInMonth; d++) {
                    const dateStr = `${currentYear}.${String(currentMonth + 1).padStart(2, '0')}.${String(d).padStart(2, '0')}`;
                    monthProfit += getDailyProfit(id, dateStr);
                }

                // ãƒªã‚¹ãƒˆã«è¡Œã‚’è¿½åŠ 
                const row = document.createElement('div');
                row.className = 'bd-row';
                row.innerHTML = `
                    <span class="bd-name">${s.name || id}</span>
                    <span class="bd-val" style="color:${monthProfit >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'}">
                        ${monthProfit.toLocaleString()}
                    </span>
                `;
                breakdownList.appendChild(row);
                hasData = true;
            });

            // ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°ã‚³ãƒ³ãƒ†ãƒŠã‚’è¡¨ç¤º
            if(breakdownContainer) breakdownContainer.style.display = hasData ? 'block' : 'none';
        }

        // 3. ç”»é¢ä¸Šã®çµ±è¨ˆæ•°å€¤æ›´æ–°
        const balEl = document.getElementById('totalBalance');
        if(balEl) balEl.textContent = totalBal.toLocaleString();
    }

    function createCell(day, amount) {
        const div = document.createElement('div');
        div.className = 'cell';
        div.innerHTML = `<div class="cell-date">${day}</div>`;
        if (amount !== 0) {
            const color = amount >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
            div.innerHTML += `<div class="cell-value" style="color:${color}">${amount.toLocaleString()}</div>`;
        }
        return div;
    }

    function getDailyProfit(id, dateStr) {
        if (!accountsData[id]) return 0;
        return accountsData[id].history
            .filter(h => h.close_time.startsWith(dateStr))
            .reduce((sum, h) => sum + h.profit, 0);
    }

    // --- è¨­å®šç”»é¢ã¨ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ ---
    function updateDropdown() {
        const select = document.getElementById('accountSelector');
        const listContainer = document.getElementById('idListContainer');
        if (!select || !listContainer) return;

        const currentVal = select.value;
        select.innerHTML = '<option value="all">ALL ACCOUNTS</option>';
        listContainer.innerHTML = '';

        allAccountIds.forEach(id => {
            const s = accountSettings[id] || { name: '', isHidden: false };
            if (!s.isHidden) {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = s.name || id;
                select.appendChild(option);
            }

            const row = document.createElement('div');
            row.className = 'setting-row';
            row.innerHTML = `
                <div style="font-size:10px; color:var(--text-dim); width:60px;">${id}</div>
                <input type="text" id="name-${id}" value="${s.name || ''}" placeholder="Name">
                <label style="font-size:10px;"><input type="checkbox" id="hide-${id}" ${s.isHidden ? 'checked' : ''}> Hide</label>
            `;
            listContainer.appendChild(row);
        });

        if (currentVal) select.value = currentVal;
    }

    async function saveAndClose() {
        allAccountIds.forEach(id => {
            const nameInput = document.getElementById(`name-${id}`);
            const hideInput = document.getElementById(`hide-${id}`);
            if (nameInput) {
                accountSettings[id] = {
                    name: nameInput.value || id,
                    isHidden: hideInput.checked
                };
            }
        });

        try {
            const res = await fetch(BASE_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ settings: accountSettings })
            });
            if (res.ok) {
                alert("âœ… Saved!");
                closeSettings();
                location.reload();
            } else {
                alert("Error: " + await res.text());
            }
        } catch (e) {
            alert("Connection Error");
        }
    }

    // --- â˜…å¾©æ´»ï¼šãƒ†ãƒ¼ãƒåˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½ ---
    function changeTheme(themeName) {
        document.body.className = themeName; // bodyã«ã‚¯ãƒ©ã‚¹ã‚’ã¤ã‘ã‚‹æ–¹å¼ã¨ä»®å®š
        // ã‚‚ã—CSSãƒ•ã‚¡ã‚¤ãƒ«ã®åˆ‡ã‚Šæ›¿ãˆãŒå¿…è¦ãªã‚‰ä»¥ä¸‹ã®ã‚ˆã†ã«å®Ÿè£…
        // document.getElementById('theme-link').href = `theme-${themeName}.css`;
        localStorage.setItem('selected_theme', themeName);
    }

    function changeMonth(step) {
        currentMonth += step;
        if (currentMonth > 11) { currentMonth = 0; currentYear++; }
        if (currentMonth < 0) { currentMonth = 11; currentYear--; }
        updateUI();
    }
    
    function switchType(type) {
        currentType = type;
        document.getElementById('btnReal').classList.toggle('active', type === 'Real');
        document.getElementById('btnDemo').classList.toggle('active', type === 'Demo');
        // å¿…è¦ãªã‚‰ã“ã“ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã‚’è¿½åŠ 
    }

    function openSettings() {
        document.getElementById('settingsModal').style.display = 'flex';
        updateDropdown();
    }
    function closeSettings() {
        document.getElementById('settingsModal').style.display = 'none';
    }
</script>
</body>
</html>

